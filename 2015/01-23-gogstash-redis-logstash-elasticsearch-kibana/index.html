<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    中等規模環境下的集中式 Log 管理及分析 // TsaiKD Blog
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="">

  <meta property="og:title" content="中等規模環境下的集中式 Log 管理及分析" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="http://tsaikd.org/blog/css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="TsaiKD Blog" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', "UA-151772-4", 'auto');
  ga('send', 'pageview');
</script>

</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

    <a href="http://tsaikd.org/blog"><h1 class="brand-title">TsaiKD Blog</h1></a>
    

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="/">Home</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="https://github.com/tsaikd">GitHub</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="https://www.facebook.com/tsaikd" target="_blank"><i class='fa fa-facebook'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		
		
			
		    <div id="toc" class="pure-u-1 pure-u-md-1-4">
				<small class="toc-label">Contents</small>
		   	 	<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#shipper-設定:04c6e90faac2675aa89e2176d2eec7d8">Shipper 設定</a></li>
<li><a href="#broker-設定:04c6e90faac2675aa89e2176d2eec7d8">Broker 設定</a></li>
<li><a href="#indexer-設定:04c6e90faac2675aa89e2176d2eec7d8">Indexer 設定</a></li>
<li><a href="#storage-search-設定:04c6e90faac2675aa89e2176d2eec7d8">Storage &amp; Search 設定</a></li>
<li><a href="#web-interface-設定:04c6e90faac2675aa89e2176d2eec7d8">Web Interface 設定</a></li>
<li><a href="#qa:04c6e90faac2675aa89e2176d2eec7d8">QA</a></li>
<li><a href="#demo-截圖:04c6e90faac2675aa89e2176d2eec7d8">Demo 截圖</a></li>
</ul></li>
</ul>
</nav>
		    </div>
		    
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/">中等規模環境下的集中式 Log 管理及分析</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>23</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Jan</span> <span class="post-date-year">2015</span>
            	</span>
            	
            
            	
            

			
			

			
		    	<div class="social-sharing">
	<a class="share-button-facebook" onClick="return popupShare(this.href);" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftsaikd.org%2fblog%2f2015%2f01-23-gogstash-redis-logstash-elasticsearch-kibana%2f" target="_blank"><i class="fa fa-facebook"><span>Like</span></i></a>
	<a class="share-button-google-plus" onClick="return popupShare(this.href);" href="https://plus.google.com/share?url=http%3a%2f%2ftsaikd.org%2fblog%2f2015%2f01-23-gogstash-redis-logstash-elasticsearch-kibana%2f" target="_blank"><i class="fa fa-google-plus"><span>Google +1</span></i></a>
	<a class="share-button-linkedin" onClick="return popupShare(this.href);" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2ftsaikd.org%2fblog%2f2015%2f01-23-gogstash-redis-logstash-elasticsearch-kibana%2f&title=%e4%b8%ad%e7%ad%89%e8%a6%8f%e6%a8%a1%e7%92%b0%e5%a2%83%e4%b8%8b%e7%9a%84%e9%9b%86%e4%b8%ad%e5%bc%8f%20Log%20%e7%ae%a1%e7%90%86%e5%8f%8a%e5%88%86%e6%9e%90&summary=Log%20%e9%9b%86%e4%b8%ad%e7%ae%a1%e7%90%86%e5%8f%af%e4%bb%a5%e6%8f%90%e4%be%9b%e9%80%b2%e4%b8%80%e6%ad%a5%e7%9a%84%e5%88%86%e6%9e%90%ef%bc%8c%e8%ae%93%e7%b3%bb%e7%b5%b1%e7%ae%a1%e7%90%86%e8%80%85%e5%9c%a8%e7%99%bc%e7%94%9f%e5%95%8f%e9%a1%8c%e7%9a%84%e6%99%82%e5%80%99%e5%8f%af%e4%bb%a5%e6%9b%b4%e5%bf%ab%e7%9a%84%e6%8e%92%e9%99%a4%e9%8c%af%e8%aa%a4%20%ef%bc%8c%e4%b9%9f%e5%8f%af%e4%bb%a5%e7%9c%8b%e5%87%ba%e6%9f%90%e4%ba%9b%e8%b6%a8%e5%8b%a2%ef%bc%8c%e6%8f%90%e6%97%a9%e5%81%9a%e5%87%ba%e4%b8%80%e4%ba%9b%e5%8f%af%e8%83%bd%e6%9c%89%e5%bd%b1%e9%9f%bf%e7%9a%84%e6%b1%ba%e7%ad%96%e3%80%82%e7%9b%ae%e5%89%8d%e5%85%b6%e5%af%a6%e6%9c%89%e4%b8%8d%e5%b0%91%e7%9a%84%e5%b7%a5%e5%85%b7%e9%83%bd%e5%8f%af%e4%bb%a5%e7%94%a8%20%e5%9c%a8%e8%99%95%e7%90%86%20Log%20%e9%9b%86%e4%b8%ad%e7%ae%a1%e7%90%86%e7%9a%84%e5%95%8f%e9%a1%8c%ef%bc%8c%e6%88%91%e9%80%99%e9%82%8a%e4%b9%9f%e6%8f%90%e4%be%9b%e4%b8%80%e5%80%8b%e4%b8%ad%e7%ad%89%e8%a6%8f%e6%a8%a1%e7%9a%84%e8%a7%a3%e6%b1%ba%e6%96%b9%e6%a1%88%e3%80%82%20%e5%9c%a8%e5%b0%8f%e5%9e%8b%e7%9a%84%e7%92%b0%e5%a2%83%28%e5%96%ae%e6%a9%9f%ef%bc%8c%e5%b0%91%e9%87%8f%e7%a8%8b%e5%bc%8f%29%20Log%20%e5%85%b6%e5%af%a6%e9%9a%a8%e4%be%bf%e4%ba%82%e6%94%be%e9%83%bd%e6%b2%92%e5%b7%ae%ef%bc%8c%e9%80%9a%e5%b8%b8%e9%83%bd%e5%8f%aa%e6%9c%89%e5%9c%a8%e5%87%ba%e5%95%8f%e9%a1%8c%e7%9a%84%e6%99%82%e5%80%99%e6%89%8d%20%e6%9c%83%e5%8e%bb%e6%92%88%20Log%20%e5%8d%94%e5%8a%a9%e6%8e%92%e9%99%a4%e5%95%8f%e9%a1%8c%e3%80%82%e5%9c%a8%e5%a4%a7%e5%9e%8b%e7%9a%84%e7%92%b0%e5%a2%83%28%e6%95%b8%e4%bb%a5%e7%99%be%e8%a8%88%e7%9a%84%e4%b8%bb%e6%a9%9f%e8%b7%9f%20App%20%e4%bb%a5%e4%b8%8a%29%ef%bc%8c%e3%84%9c~~~~%e6%88%91%e6%b2%92%e7%b6%93%e9%a9%97%20%e4%b8%8d%e6%95%a2%e9%9a%a8%e6%84%8f%e7%8c%9c%e6%b8%ac%e3%80%82%e6%89%80%e4%bb%a5%e9%80%99%e9%82%8a%e6%98%af%e7%94%a8%e4%b8%80%e5%80%8b%e6%95%b8%e5%8d%81%e5%8f%b0%20MongoDB%20%e7%9a%84%e7%92%b0%e5%a2%83%e4%be%86%e8%a8%8e%e8%ab%96%20Log%20%e9%9b%86%e4%b8%ad%e7%ae%a1%e7%90%86%e7%9a%84%e8%99%95%e7%90%86%20%e6%96%b9%e5%bc%8f%e3%80%82%20%e5%9c%a8%20Logstash%20%e7%9a%84%e4%bd%bf%e7%94%a8%e6%83%85%e5%a2%83%e4%b8%8b%ef%bc%8c%e6%9c%89%e5%b9%be%e7%a8%ae%e5%85%b8%e5%9e%8b%e8%a7%92%e8%89%b2%ef%bc%9a%20%e9%80%99%e9%82%8a%e5%81%b7%e7%94%a8%e4%ba%86%20Logstash%20Document%20%e7%9a%84%e5%9c%96%20Shipper%20%e8%92%90%e9%9b%86%20Broker%20%e6%9a%ab%e5%ad%98%20Indexer%20%e8%a7%a3%e6%9e%90%20Storage%20%26amp%3b%20Search%20%e6%b0%b8%e4%b9%85%e5%84%b2%e5%ad%98%20Web%20Interface%20%e5%88%86%e6%9e%90%e7%95%8c%e9%9d%a2%20Shipper%20%2b%20Broker%20%2b%20Indexer%20%e5%9c%a8%e5%b0%8f%e5%9e%8b%e7%9a%84%e7%92%b0%e5%a2%83%e5%85%b6%e5%af%a6%e5%8f%af%e4%bb%a5%e6%95%b4%e5%90%88%e5%9c%a8%e5%90%8c%e4%b8%80%e5%80%8b%20Logstash%20%e8%a3%a1%e9%9d%a2%e4%b8%80%e6%ac%a1%20%e8%99%95%e7%90%86%ef%bc%8c%e4%b8%8d%e9%81%8e%e4%b8%80%e9%96%8b%e5%a7%8b%e4%b9%9f%e6%9c%89%e6%8f%90%e5%88%b0%ef%bc%8c%e5%9c%a8%e5%b0%8f%e5%9e%8b%e7%9a%84%e7%92%b0%e5%a2%83%ef%bc%8c%e5%93%aa%e6%9c%89%e4%ba%ba%e5%9c%a8%e6%90%9e%e8%a4%87%e9%9b%9c%e7%9a%84%20Log%20%e5%88%86%e6%9e%90%26hellip%3bXD%ef%bc%8c%e6%97%a2%e7%84%b6%e8%a6%81%e5%81%9a%20%e5%b0%b1%e4%b8%80%e6%ac%a1%e5%81%9a%e5%88%b0%e4%bd%8d%e5%90%a7%e3%80%82%20%e4%b8%8d%e9%81%8e%e9%80%99%e9%82%8a%e9%82%84%e6%9c%89%e5%8f%a6%e4%b8%80%e5%80%8b%e5%95%8f%e9%a1%8c%ef%bc%8c%e5%b0%b1%e6%98%af%20Logstash%20%e6%98%af%e7%94%a8%20Ruby%20%e5%af%ab%e7%9a%84%ef%bc%8c%e7%84%b6%20%e5%be%8c%e9%80%8f%e9%81%8e%20Java%20%e4%be%86%e5%9f%b7%e8%a1%8c%ef%bc%8c%e6%89%80%e4%bb%a5%e9%9c%80%e8%a6%81%e5%ae%89%e8%a3%9d%20Java%ef%bc%8c%e4%bd%86%e6%98%af%e5%83%8f%e5%9c%a8%20MongoDB%20%e7%9a%84%e7%92%b0%e5%a2%83%ef%bc%8c%e6%88%91%e4%b8%8d%20%e6%83%b3%e5%9c%a8%e6%a9%9f%e5%99%a8%e4%b8%8a%e5%ae%89%e8%a3%9d%e5%a4%aa%e5%a4%9a%e9%a1%8d%e5%a4%96%e7%9a%84%e6%9d%b1%e8%a5%bf%ef%bc%8c%e8%80%8c%e4%b8%94%20Java%20%e5%85%b6%e5%af%a6%e9%82%84%e8%a0%bb%e8%82%a5%e7%9a%84%ef%bc%8c%e5%a6%82%e6%9e%9c%e5%8f%aa%e6%98%af%e5%96%ae%e7%b4%94%e7%9a%84%20Shipper%20%e8%a7%92%e8%89%b2%ef%bc%8c%e6%b2%92%e6%9c%89%e5%bf%85%e8%a6%81%e6%90%9e%e9%82%a3%e9%ba%bc%e5%a4%9a%e6%9c%89%e7%9a%84%e6%b2%92%e7%9a%84%e5%a5%97%e4%bb%b6%e6%8a%8a%e7%b3%bb%e7%b5%b1%e5%bc%84%e9%ab%92%ef%bc%8c%e6%89%80%e4%bb%a5%e6%88%91%e5%8f%a6%e5%a4%96%e9%96%8b%e7%99%bc%e4%ba%86%e4%b8%80%e5%80%8b%e5%b0%8f%e5%b7%a5%e5%85%b7%20gogstash%20%e4%be%86%e5%81%9a}&source=TsaiKD%20Blog" target="_blank"><i class="fa fa-linkedin"><span>Share on LinkedIn</span></i></a>
	<a class="share-button-twitter" onClick="return popupShare(this.href);" href="http://twitter.com/share?text=%e4%b8%ad%e7%ad%89%e8%a6%8f%e6%a8%a1%e7%92%b0%e5%a2%83%e4%b8%8b%e7%9a%84%e9%9b%86%e4%b8%ad%e5%bc%8f%20Log%20%e7%ae%a1%e7%90%86%e5%8f%8a%e5%88%86%e6%9e%90&url=http%3a%2f%2ftsaikd.org%2fblog%2f2015%2f01-23-gogstash-redis-logstash-elasticsearch-kibana%2f" target="_blank"><i class="fa fa-twitter"><span>Tweet</span></i></a>	
</div>
		    

			

            

<p>Log 集中管理可以提供進一步的分析，讓系統管理者在發生問題的時候可以更快的排除錯誤
，也可以看出某些趨勢，提早做出一些可能有影響的決策。目前其實有不少的工具都可以用
在處理 Log 集中管理的問題，我這邊也提供一個中等規模的解決方案。</p>

<p>在小型的環境(單機，少量程式) Log 其實隨便亂放都沒差，通常都只有在出問題的時候才
會去撈 Log 協助排除問題。在大型的環境(數以百計的主機跟 App 以上)，ㄜ~~~~我沒經驗
不敢隨意猜測。所以這邊是用一個數十台 <a href="http://www.mongodb.org/">MongoDB</a> 的環境來討論 Log 集中管理的處理
方式。</p>

<p>在 <a href="http://logstash.net/">Logstash</a> 的使用情境下，有幾種典型角色：</p>

<p><img src="getting-started-centralized-overview-diagram.png" alt="" />
</p>

<blockquote>
<p><a href="http://logstash.net/docs/1.1.1/tutorials/getting-started-centralized">這邊偷用了 Logstash Document 的圖</a></p>
</blockquote>

<ul>
<li>Shipper

<ul>
<li>蒐集</li>
</ul></li>
<li>Broker

<ul>
<li>暫存</li>
</ul></li>
<li>Indexer

<ul>
<li>解析</li>
</ul></li>
<li>Storage &amp; Search

<ul>
<li>永久儲存</li>
</ul></li>
<li>Web Interface

<ul>
<li>分析界面</li>
</ul></li>
</ul>

<p>Shipper + Broker + Indexer 在小型的環境其實可以整合在同一個 <a href="http://logstash.net/">Logstash</a> 裡面一次
處理，不過一開始也有提到，在小型的環境，哪有人在搞複雜的 Log 分析&hellip;XD，既然要做
就一次做到位吧。</p>

<p>不過這邊還有另一個問題，就是 <a href="http://logstash.net/">Logstash</a> 是用 <a href="https://www.ruby-lang.org/zh_tw/">Ruby</a> 寫的，然
後透過 <a href="https://java.com/zh_TW/">Java</a> 來執行，所以需要安裝 <a href="https://java.com/zh_TW/">Java</a>，但是像在 <a href="http://www.mongodb.org/">MongoDB</a> 的環境，我不
想在機器上安裝太多額外的東西，而且 <a href="https://java.com/zh_TW/">Java</a> 其實還蠻肥的，如果只是單純的 Shipper
角色，沒有必要搞那麼多有的沒的套件把系統弄髒，所以我另外開發了一個小工具 <a href="https://github.com/tsaikd/gogstash">gogstash</a>
來做 Shipper 的工作。</p>

<p>Broker 選用 <a href="http://redis.io/">Redis</a>，聽說效能不錯？</p>

<p>Indexer 仍然使用 <a href="http://logstash.net/">Logstash</a> ，因為 <a href="http://logstash.net/">Logstash</a> 已經有蠻多方便的設定可以快速的
解析各式各樣的 Log 。</p>

<p>Storage &amp; Search 選擇 <a href="http://www.elasticsearch.org/">ElasticSearch</a> ，它使用了 <a href="http://lucene.apache.org/">Lucene</a> 當基底，可以有效率
的分析及處理各種自然語言，不過其實對一般的 Log 來說，大部分的情況不會用到太深入的
功能，有點用牛刀殺雞的感覺，反正 <a href="http://www.elasticsearch.org/">ElasticSearch</a> 也還蠻好用的，就這樣吧&hellip;<code>^_^</code></p>

<p>Web Interface 選擇 3.x 版的 <a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a> ，它可以在網頁上展示還不錯看的報表。</p>

<h2 id="shipper-設定:04c6e90faac2675aa89e2176d2eec7d8">Shipper 設定</h2>

<p><a href="http://www.mongodb.org/">MongoDB</a> 的部份這邊先不討論，只是拿來當個案例而已。 Shipper 的重點就是要把所有
機器上的 Log 都送到 Broker ，我這邊想要蒐集的資料包括了 <a href="http://www.mongodb.org/">MongoDB</a> 本身的 Log ，
還有機器的狀態也想要一併分析，所以有幾個 <a href="https://github.com/tsaikd/gogstash">gogstash</a> 的設定。</p>

<ul>
<li><a href="gogstash/mongodb.json">蒐集 /var/log/mongodb/mongodb.log</a></li>
<li><a href="gogstash/mongodb-status.json">蒐集 MongoDB 服務狀態</a></li>
<li><a href="gogstash/mongodb-df.json">蒐集硬碟空間使用狀況</a></li>
<li><a href="gogstash/mongodb-sys.json">蒐集系統負載資訊</a></li>
</ul>

<h2 id="broker-設定:04c6e90faac2675aa89e2176d2eec7d8">Broker 設定</h2>

<p><a href="http://redis.io/">Redis</a> 要做一個稱職的 Broker 其實有點麻煩，因為它可能是因為效率的問題，在
<a href="http://en.wikipedia.org/wiki/High_availability">High availability</a> 方面的設計不是很理想，不過也還算堪用，只是設定上有點難搞&hellip;Orz
，我目前使用 <a href="https://www.docker.com/">Docker</a> 來建構 <a href="http://redis.io/">Redis</a> 環境，裡面有用<a href="https://github.com/tsaikd/fig">我 Patch 過的 Fig</a>
，另外 Docker Image 是用 <a href="https://github.com/tsaikd/docker-builder">Docker Builder</a> 建出來的， <a href="http://redis.io/">Redis</a> 的 sentinel 情況
比較麻煩，可能還是要參考一下<a href="http://redis.io/topics/sentinel">Redis Sentinel</a> 官方文件才比較容易理解。底下列出一
些相關的設定方式給大家參考。</p>

<ul>
<li><a href="redis/fig.yml">fig.yml</a></li>
<li><a href="redis/redis/redis.conf">redis/redis.conf</a>

<ul>
<li><a href="http://redis.io/">Redis</a> 基本設定</li>
</ul></li>
<li><a href="redis/redis/sentinel.conf">redis/sentinel.conf</a>

<ul>
<li><a href="http://redis.io/">Redis</a> Sentinel 設定</li>
</ul></li>
<li><a href="redis/redis/start.sh">redis/start.sh</a>

<ul>
<li><a href="https://github.com/tsaikd/docker-builder">Docker Builder</a> 啟動腳本</li>
</ul></li>
</ul>

<h2 id="indexer-設定:04c6e90faac2675aa89e2176d2eec7d8">Indexer 設定</h2>

<p>Indexer 其實是 Log 分析的一大重點，因為 Log 可能會有各式各樣的描述，再加上每個人
想分析的東西不盡相同，所以很難用一個標準化的設定就能通吃所有情況，這邊我是用 <a href="http://www.mongodb.org/">MongoDB</a>
系統管理者的角度來處理 Log。</p>

<ul>
<li><a href="logstash/fig.yml">fig.yml</a></li>
<li><a href="logstash/logstash/index-mongodb.conf">logstash/index-mongodb.conf</a>

<ul>
<li>分析 <a href="http://www.mongodb.org/">MongoDB</a> Log</li>
</ul></li>
<li><a href="logstash/logstash/index-mongodb-status.conf">logstash/index-mongodb-status.conf</a>

<ul>
<li>分析 <a href="http://www.mongodb.org/">MongoDB</a> 服務狀態</li>
</ul></li>
<li><a href="logstash/logstash/index-mongodb-df.conf">logstash/index-mongodb-df.conf</a>

<ul>
<li>分析硬碟空間使用狀況</li>
</ul></li>
<li><a href="logstash/logstash/index-mongodb-sys.conf">logstash/index-mongodb-sys.conf</a>

<ul>
<li>分析系統負載資訊</li>
</ul></li>
<li><a href="logstash/logstash/start.sh">logstash/start.sh</a>

<ul>
<li><a href="https://github.com/tsaikd/docker-builder">Docker Builder</a> 啟動腳本</li>
</ul></li>
</ul>

<h2 id="storage-search-設定:04c6e90faac2675aa89e2176d2eec7d8">Storage &amp; Search 設定</h2>

<p><a href="http://www.elasticsearch.org/">ElasticSearch</a> 最常見的問題其實是它預設在建索引的時候會自動分詞之後才儲存，這
樣會在做分組統計的時候出現狀況，像是 &ldquo;connection accepted&rdquo; 這個詞會被拆成 &ldquo;connection&rdquo;
&ldquo;accepted&rdquo; 這兩個詞來做統計，但是其實我想要的是 &ldquo;connection accepted&rdquo; 整個詞來進
行統計，所以某些欄位需要額外設定讓它不要分詞，詳細的設定還是要參考 <a href="http://www.elasticsearch.org/">ElasticSearch</a>
相關文件，底下設定給大家參考。</p>

<ul>
<li><a href="elasticsearch/fig.yml">fig.yml</a></li>
<li><a href="elasticsearch/eslogstash/elasticsearch.yml">eslogstash/elasticsearch.yml</a>

<ul>
<li>ElasticSearch 基本設定</li>
</ul></li>
<li><a href="elasticsearch/eslogstash/logging.yml">eslogstash/logging.yml</a>

<ul>
<li>這個檔案基本上沒有修改，只是方便 <a href="http://www.fig.sh/">Fig</a> 直接把整個目錄掛進去</li>
</ul></li>
<li><a href="elasticsearch/eslogstash/analysis/stopword.txt">eslogstash/analysis/stopword.txt</a>

<ul>
<li>用來排除某些特定(不感興趣)的詞</li>
</ul></li>
<li><a href="elasticsearch/eslogstash/analysis/synonym.txt">eslogstash/analysis/synonym.txt</a>

<ul>
<li>設定同義詞</li>
</ul></li>
<li><a href="elasticsearch/eslogstash/templates/kdtmpl.json">eslogstash/templates/kdtmpl.json</a>

<ul>
<li>動態模板，把 <code>*_facet</code> 欄位預設成不分詞</li>
</ul></li>
</ul>

<h2 id="web-interface-設定:04c6e90faac2675aa89e2176d2eec7d8">Web Interface 設定</h2>

<p><a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a> 的設定就相對簡單很多，主要是因為我用 <a href="https://www.docker.com/">Docker</a> 把 <a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a> 跟 <a href="http://www.elasticsearch.org/">ElasticSearch</a>
的環境分開，不然可以免設定就直接用了。</p>

<ul>
<li><a href="kibana/fig.yml">fig.yml</a></li>
<li><a href="./kibana/kibana/config.js">kibana/config.js</a></li>
</ul>

<h2 id="qa:04c6e90faac2675aa89e2176d2eec7d8">QA</h2>

<ul>
<li>上面的 fig.yml 有些奇怪的環境變數像是 <code>SERVICE_9200_DNS=eslogstash</code> 是在幹嘛的？</li>
</ul>

<p>這些是我在 <a href="../../2014/12-25-Docker-infra">Docker Infra 架構簡介與實例</a> 這邊提到
的架構，其中的某些設定，因為有點複雜，有興趣的就自行閱讀吧，反正把那些服務串起來
就對了。</p>

<p>另外 <code>DOCKER_WAITEXIT=1</code> 這個是 <a href="https://github.com/tsaikd/docker-builder">Docker Builder</a> 提供的一個設定</p>

<ul>
<li>為什麼不用 <a href="https://github.com/elasticsearch/logstash-forwarder">logstash-forwarder</a> 就好，還另外重刻一個 <a href="https://github.com/tsaikd/gogstash">gogstash</a> ？</li>
</ul>

<p>其實我之前也有試用過 <a href="https://github.com/elasticsearch/logstash-forwarder">logstash-forwarder</a> ，但是後來還是放棄了，因為 <a href="https://github.com/elasticsearch/logstash-forwarder">logstash-forwarder</a>
目前只有支援 <a href="https://github.com/elasticsearch/logstash-forwarder/blob/master/PROTOCOL.md">lumberjack</a> 這種輸出方式，而且我還沒找到可以方便弄成 <a href="http://en.wikipedia.org/wiki/High_availability">High availability</a>
的辦法，標題有提到這邊主要是要解決針對中等規模環境下的問題，所以我認為 <a href="http://en.wikipedia.org/wiki/High_availability">High availability</a>
還蠻重要的，用 <a href="https://github.com/elasticsearch/logstash-forwarder">logstash-forwarder</a> 的話，只要 <a href="https://github.com/elasticsearch/logstash-forwarder/blob/master/PROTOCOL.md">lumberjack</a> 那台機器出狀況，
就會掉 Log 了，如果還是想用 <a href="https://github.com/elasticsearch/logstash-forwarder">logstash-forwarder</a> 的話，要用 <a href="http://zookeeper.apache.org/">ZooKeeper</a> 之類
的輔助方式來達成 <a href="http://en.wikipedia.org/wiki/High_availability">High availability</a> 的目的。</p>

<p>另外就是 <a href="https://github.com/elasticsearch/logstash-forwarder">logstash-forwarder</a> 本身架構上沒有設計成方便擴充的形式，所以如果要幫
它加上 <a href="http://redis.io/">Redis</a> 輸出的話，我評估起來比我重寫一個還花時間，所以就乖乖硬幹啦&hellip;XD</p>

<p>但是目前的解法也還是有一些問題，就是 <a href="http://logstash.net/">logstash</a> 吃 <a href="http://redis.io/">Redis</a> 資料的時候，沒有支
援 <a href="http://redis.io/topics/sentinel">Redis Sentinel</a> 的方式，所以要是主要的 <a href="http://redis.io/">Redis</a> 掛掉的時候，目前架構下，
Log 會一直 Queue 在 <a href="http://redis.io/">Redis</a> 上面，因為 <a href="http://logstash.net/">logstash</a> 不知道要去哪裡要資料了，要
解決這個問題的話，需要修改 <a href="http://logstash.net/docs/1.4.2/inputs/redis">Logstash Input Redis Plugin</a>，不過即使這種情況發
生了， <a href="http://redis.io/">Redis</a> 上面也還是會有資料，所以不會掉 Log ，所以就先這樣弄，看看新版的
<a href="http://logstash.net/">logstash</a> 會不會解決這個問題吧。</p>

<h2 id="demo-截圖:04c6e90faac2675aa89e2176d2eec7d8">Demo 截圖</h2>

<p><img src="kibana-demo.png" alt="" />
</p>

	
			
		    	<div class="social-sharing">
	<a class="share-button-facebook" onClick="return popupShare(this.href);" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftsaikd.org%2fblog%2f2015%2f01-23-gogstash-redis-logstash-elasticsearch-kibana%2f" target="_blank"><i class="fa fa-facebook"><span>Like</span></i></a>
	<a class="share-button-google-plus" onClick="return popupShare(this.href);" href="https://plus.google.com/share?url=http%3a%2f%2ftsaikd.org%2fblog%2f2015%2f01-23-gogstash-redis-logstash-elasticsearch-kibana%2f" target="_blank"><i class="fa fa-google-plus"><span>Google +1</span></i></a>
	<a class="share-button-linkedin" onClick="return popupShare(this.href);" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2ftsaikd.org%2fblog%2f2015%2f01-23-gogstash-redis-logstash-elasticsearch-kibana%2f&title=%e4%b8%ad%e7%ad%89%e8%a6%8f%e6%a8%a1%e7%92%b0%e5%a2%83%e4%b8%8b%e7%9a%84%e9%9b%86%e4%b8%ad%e5%bc%8f%20Log%20%e7%ae%a1%e7%90%86%e5%8f%8a%e5%88%86%e6%9e%90&summary=Log%20%e9%9b%86%e4%b8%ad%e7%ae%a1%e7%90%86%e5%8f%af%e4%bb%a5%e6%8f%90%e4%be%9b%e9%80%b2%e4%b8%80%e6%ad%a5%e7%9a%84%e5%88%86%e6%9e%90%ef%bc%8c%e8%ae%93%e7%b3%bb%e7%b5%b1%e7%ae%a1%e7%90%86%e8%80%85%e5%9c%a8%e7%99%bc%e7%94%9f%e5%95%8f%e9%a1%8c%e7%9a%84%e6%99%82%e5%80%99%e5%8f%af%e4%bb%a5%e6%9b%b4%e5%bf%ab%e7%9a%84%e6%8e%92%e9%99%a4%e9%8c%af%e8%aa%a4%20%ef%bc%8c%e4%b9%9f%e5%8f%af%e4%bb%a5%e7%9c%8b%e5%87%ba%e6%9f%90%e4%ba%9b%e8%b6%a8%e5%8b%a2%ef%bc%8c%e6%8f%90%e6%97%a9%e5%81%9a%e5%87%ba%e4%b8%80%e4%ba%9b%e5%8f%af%e8%83%bd%e6%9c%89%e5%bd%b1%e9%9f%bf%e7%9a%84%e6%b1%ba%e7%ad%96%e3%80%82%e7%9b%ae%e5%89%8d%e5%85%b6%e5%af%a6%e6%9c%89%e4%b8%8d%e5%b0%91%e7%9a%84%e5%b7%a5%e5%85%b7%e9%83%bd%e5%8f%af%e4%bb%a5%e7%94%a8%20%e5%9c%a8%e8%99%95%e7%90%86%20Log%20%e9%9b%86%e4%b8%ad%e7%ae%a1%e7%90%86%e7%9a%84%e5%95%8f%e9%a1%8c%ef%bc%8c%e6%88%91%e9%80%99%e9%82%8a%e4%b9%9f%e6%8f%90%e4%be%9b%e4%b8%80%e5%80%8b%e4%b8%ad%e7%ad%89%e8%a6%8f%e6%a8%a1%e7%9a%84%e8%a7%a3%e6%b1%ba%e6%96%b9%e6%a1%88%e3%80%82%20%e5%9c%a8%e5%b0%8f%e5%9e%8b%e7%9a%84%e7%92%b0%e5%a2%83%28%e5%96%ae%e6%a9%9f%ef%bc%8c%e5%b0%91%e9%87%8f%e7%a8%8b%e5%bc%8f%29%20Log%20%e5%85%b6%e5%af%a6%e9%9a%a8%e4%be%bf%e4%ba%82%e6%94%be%e9%83%bd%e6%b2%92%e5%b7%ae%ef%bc%8c%e9%80%9a%e5%b8%b8%e9%83%bd%e5%8f%aa%e6%9c%89%e5%9c%a8%e5%87%ba%e5%95%8f%e9%a1%8c%e7%9a%84%e6%99%82%e5%80%99%e6%89%8d%20%e6%9c%83%e5%8e%bb%e6%92%88%20Log%20%e5%8d%94%e5%8a%a9%e6%8e%92%e9%99%a4%e5%95%8f%e9%a1%8c%e3%80%82%e5%9c%a8%e5%a4%a7%e5%9e%8b%e7%9a%84%e7%92%b0%e5%a2%83%28%e6%95%b8%e4%bb%a5%e7%99%be%e8%a8%88%e7%9a%84%e4%b8%bb%e6%a9%9f%e8%b7%9f%20App%20%e4%bb%a5%e4%b8%8a%29%ef%bc%8c%e3%84%9c~~~~%e6%88%91%e6%b2%92%e7%b6%93%e9%a9%97%20%e4%b8%8d%e6%95%a2%e9%9a%a8%e6%84%8f%e7%8c%9c%e6%b8%ac%e3%80%82%e6%89%80%e4%bb%a5%e9%80%99%e9%82%8a%e6%98%af%e7%94%a8%e4%b8%80%e5%80%8b%e6%95%b8%e5%8d%81%e5%8f%b0%20MongoDB%20%e7%9a%84%e7%92%b0%e5%a2%83%e4%be%86%e8%a8%8e%e8%ab%96%20Log%20%e9%9b%86%e4%b8%ad%e7%ae%a1%e7%90%86%e7%9a%84%e8%99%95%e7%90%86%20%e6%96%b9%e5%bc%8f%e3%80%82%20%e5%9c%a8%20Logstash%20%e7%9a%84%e4%bd%bf%e7%94%a8%e6%83%85%e5%a2%83%e4%b8%8b%ef%bc%8c%e6%9c%89%e5%b9%be%e7%a8%ae%e5%85%b8%e5%9e%8b%e8%a7%92%e8%89%b2%ef%bc%9a%20%e9%80%99%e9%82%8a%e5%81%b7%e7%94%a8%e4%ba%86%20Logstash%20Document%20%e7%9a%84%e5%9c%96%20Shipper%20%e8%92%90%e9%9b%86%20Broker%20%e6%9a%ab%e5%ad%98%20Indexer%20%e8%a7%a3%e6%9e%90%20Storage%20%26amp%3b%20Search%20%e6%b0%b8%e4%b9%85%e5%84%b2%e5%ad%98%20Web%20Interface%20%e5%88%86%e6%9e%90%e7%95%8c%e9%9d%a2%20Shipper%20%2b%20Broker%20%2b%20Indexer%20%e5%9c%a8%e5%b0%8f%e5%9e%8b%e7%9a%84%e7%92%b0%e5%a2%83%e5%85%b6%e5%af%a6%e5%8f%af%e4%bb%a5%e6%95%b4%e5%90%88%e5%9c%a8%e5%90%8c%e4%b8%80%e5%80%8b%20Logstash%20%e8%a3%a1%e9%9d%a2%e4%b8%80%e6%ac%a1%20%e8%99%95%e7%90%86%ef%bc%8c%e4%b8%8d%e9%81%8e%e4%b8%80%e9%96%8b%e5%a7%8b%e4%b9%9f%e6%9c%89%e6%8f%90%e5%88%b0%ef%bc%8c%e5%9c%a8%e5%b0%8f%e5%9e%8b%e7%9a%84%e7%92%b0%e5%a2%83%ef%bc%8c%e5%93%aa%e6%9c%89%e4%ba%ba%e5%9c%a8%e6%90%9e%e8%a4%87%e9%9b%9c%e7%9a%84%20Log%20%e5%88%86%e6%9e%90%26hellip%3bXD%ef%bc%8c%e6%97%a2%e7%84%b6%e8%a6%81%e5%81%9a%20%e5%b0%b1%e4%b8%80%e6%ac%a1%e5%81%9a%e5%88%b0%e4%bd%8d%e5%90%a7%e3%80%82%20%e4%b8%8d%e9%81%8e%e9%80%99%e9%82%8a%e9%82%84%e6%9c%89%e5%8f%a6%e4%b8%80%e5%80%8b%e5%95%8f%e9%a1%8c%ef%bc%8c%e5%b0%b1%e6%98%af%20Logstash%20%e6%98%af%e7%94%a8%20Ruby%20%e5%af%ab%e7%9a%84%ef%bc%8c%e7%84%b6%20%e5%be%8c%e9%80%8f%e9%81%8e%20Java%20%e4%be%86%e5%9f%b7%e8%a1%8c%ef%bc%8c%e6%89%80%e4%bb%a5%e9%9c%80%e8%a6%81%e5%ae%89%e8%a3%9d%20Java%ef%bc%8c%e4%bd%86%e6%98%af%e5%83%8f%e5%9c%a8%20MongoDB%20%e7%9a%84%e7%92%b0%e5%a2%83%ef%bc%8c%e6%88%91%e4%b8%8d%20%e6%83%b3%e5%9c%a8%e6%a9%9f%e5%99%a8%e4%b8%8a%e5%ae%89%e8%a3%9d%e5%a4%aa%e5%a4%9a%e9%a1%8d%e5%a4%96%e7%9a%84%e6%9d%b1%e8%a5%bf%ef%bc%8c%e8%80%8c%e4%b8%94%20Java%20%e5%85%b6%e5%af%a6%e9%82%84%e8%a0%bb%e8%82%a5%e7%9a%84%ef%bc%8c%e5%a6%82%e6%9e%9c%e5%8f%aa%e6%98%af%e5%96%ae%e7%b4%94%e7%9a%84%20Shipper%20%e8%a7%92%e8%89%b2%ef%bc%8c%e6%b2%92%e6%9c%89%e5%bf%85%e8%a6%81%e6%90%9e%e9%82%a3%e9%ba%bc%e5%a4%9a%e6%9c%89%e7%9a%84%e6%b2%92%e7%9a%84%e5%a5%97%e4%bb%b6%e6%8a%8a%e7%b3%bb%e7%b5%b1%e5%bc%84%e9%ab%92%ef%bc%8c%e6%89%80%e4%bb%a5%e6%88%91%e5%8f%a6%e5%a4%96%e9%96%8b%e7%99%bc%e4%ba%86%e4%b8%80%e5%80%8b%e5%b0%8f%e5%b7%a5%e5%85%b7%20gogstash%20%e4%be%86%e5%81%9a}&source=TsaiKD%20Blog" target="_blank"><i class="fa fa-linkedin"><span>Share on LinkedIn</span></i></a>
	<a class="share-button-twitter" onClick="return popupShare(this.href);" href="http://twitter.com/share?text=%e4%b8%ad%e7%ad%89%e8%a6%8f%e6%a8%a1%e7%92%b0%e5%a2%83%e4%b8%8b%e7%9a%84%e9%9b%86%e4%b8%ad%e5%bc%8f%20Log%20%e7%ae%a1%e7%90%86%e5%8f%8a%e5%88%86%e6%9e%90&url=http%3a%2f%2ftsaikd.org%2fblog%2f2015%2f01-23-gogstash-redis-logstash-elasticsearch-kibana%2f" target="_blank"><i class="fa fa-twitter"><span>Tweet</span></i></a>	
</div>
		    

			
				<div class="tags-list">
					<span class="dark-red">Tags</span><span class="decorative-marker">//</span>
					
	                <a class="post-tag post-tag-gogstash" href="http://tsaikd.org/blog/tags/gogstash">gogstash</a>,
	                
	                <a class="post-tag post-tag-redis" href="http://tsaikd.org/blog/tags/redis">Redis</a>,
	                
	                <a class="post-tag post-tag-logstash" href="http://tsaikd.org/blog/tags/logstash">Logstash</a>,
	                
	                <a class="post-tag post-tag-elasticsearch" href="http://tsaikd.org/blog/tags/elasticsearch">ElasticSearch</a>,
	                
	                <a class="post-tag post-tag-kibana" href="http://tsaikd.org/blog/tags/kibana">Kibana</a>,
	                
				</div>
			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/blog/2014/12-25-Docker-infra/">Docker Infra 架構簡介與實例</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>

	<p>&copy; 2015. All rights reserved. </p>
</div>
    </div>
  </div>
	

	
		<script type="text/javascript">
			function popupShare(url) {
				window.open(url, '_blank', 'scrollbars,resizable,height=525,width=600');
				return false;
			}
		</script>
	

  
</body>
</html>