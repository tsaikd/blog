<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    中等規模環境下的集中式 Log 管理及分析 // TsaiKD Blog
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="">

  <meta property="og:title" content="中等規模環境下的集中式 Log 管理及分析" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="http://tsaikd.org/blog/css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="TsaiKD Blog" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

    <h1 class="brand-title">TsaiKD Blog</h1>
    

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="http://tsaikd.org/blog">Home</a></li>
        
      </ul>
    </nav>

    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		
		
			
		    <div id="toc" class="pure-u-1 pure-u-md-1-4">
				<small class="toc-label">Contents</small>
		   	 	<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#shipper-設定:04c6e90faac2675aa89e2176d2eec7d8">Shipper 設定</a></li>
<li><a href="#broker-設定:04c6e90faac2675aa89e2176d2eec7d8">Broker 設定</a></li>
<li><a href="#indexer-設定:04c6e90faac2675aa89e2176d2eec7d8">Indexer 設定</a></li>
<li><a href="#storage-search-設定:04c6e90faac2675aa89e2176d2eec7d8">Storage &amp; Search 設定</a></li>
<li><a href="#web-interface-設定:04c6e90faac2675aa89e2176d2eec7d8">Web Interface 設定</a></li>
<li><a href="#qa:04c6e90faac2675aa89e2176d2eec7d8">QA</a></li>
<li><a href="#demo-截圖:04c6e90faac2675aa89e2176d2eec7d8">Demo 截圖</a></li>
</ul></li>
</ul>
</nav>
		    </div>
		    
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/">中等規模環境下的集中式 Log 管理及分析</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>23</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Jan</span> <span class="post-date-year">2015</span>
            	</span>
            	
            
            	
            

			
			

			

			

            

<p>Log 集中管理可以提供進一步的分析，讓系統管理者在發生問題的時候可以更快的排除錯誤
，也可以看出某些趨勢，提早做出一些可能有影響的決策。目前其實有不少的工具都可以用
在處理 Log 集中管理的問題，我這邊也提供一個中等規模的解決方案。</p>

<p>在小型的環境(單機，少量程式) Log 其實隨便亂放都沒差，通常都只有在出問題的時候才
會去撈 Log 協助排除問題。在大型的環境(數以百計的主機跟 App 以上)，ㄜ~~~~我沒經驗
不敢隨意猜測。所以這邊是用一個數十台 <a href="http://www.mongodb.org/">MongoDB</a> 的環境來討論 Log 集中管理的處理
方式。</p>

<p>在 <a href="http://logstash.net/">Logstash</a> 的使用情境下，有幾種典型角色：</p>

<p><img src="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/getting-started-centralized-overview-diagram.png" alt="" />

&gt; <a href="http://logstash.net/docs/1.1.1/tutorials/getting-started-centralized">這邊偷用了 Logstash Document 的圖</a></p>

<ul>
<li>Shipper

<ul>
<li>蒐集</li>
</ul></li>
<li>Broker

<ul>
<li>暫存</li>
</ul></li>
<li>Indexer

<ul>
<li>解析</li>
</ul></li>
<li>Storage &amp; Search

<ul>
<li>永久儲存</li>
</ul></li>
<li>Web Interface

<ul>
<li>分析界面</li>
</ul></li>
</ul>

<p>Shipper + Broker + Indexer 在小型的環境其實可以整合在同一個 <a href="http://logstash.net/">Logstash</a> 裡面一次
處理，不過一開始也有提到，在小型的環境，哪有人在搞複雜的 Log 分析&hellip;XD，既然要做
就一次做到位吧。</p>

<p>不過這邊還有另一個問題，就是 <a href="http://logstash.net/">Logstash</a> 是用 <a href="https://www.ruby-lang.org/zh_tw/">Ruby</a> 寫的，然
後透過 <a href="https://java.com/zh_TW/">Java</a> 來執行，所以需要安裝 <a href="https://java.com/zh_TW/">Java</a>，但是像在 <a href="http://www.mongodb.org/">MongoDB</a> 的環境，我不
想在機器上安裝太多額外的東西，而且 <a href="https://java.com/zh_TW/">Java</a> 其實還蠻肥的，如果只是單純的 Shipper
角色，沒有必要搞那麼多有的沒的套件把系統弄髒，所以我另外開發了一個小工具 <a href="https://github.com/tsaikd/gogstash">gogstash</a>
來做 Shipper 的工作。</p>

<p>Broker 選用 <a href="http://redis.io/">Redis</a>，聽說效能不錯？</p>

<p>Indexer 仍然使用 <a href="http://logstash.net/">Logstash</a> ，因為 <a href="http://logstash.net/">Logstash</a> 已經有蠻多方便的設定可以快速的
解析各式各樣的 Log 。</p>

<p>Storage &amp; Search 選擇 <a href="http://www.elasticsearch.org/">ElasticSearch</a> ，它使用了 <a href="http://lucene.apache.org/">Lucene</a> 當基底，可以有效率
的分析及處理各種自然語言，不過其實對一般的 Log 來說，大部分的情況不會用到太深入的
功能，有點用牛刀殺雞的感覺，反正 <a href="http://www.elasticsearch.org/">ElasticSearch</a> 也還蠻好用的，就這樣吧&hellip;<code>^_^</code></p>

<p>Web Interface 選擇 3.x 版的 <a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a> ，它可以在網頁上展示還不錯看的報表。</p>

<h2 id="shipper-設定:04c6e90faac2675aa89e2176d2eec7d8">Shipper 設定</h2>

<p><a href="http://www.mongodb.org/">MongoDB</a> 的部份這邊先不討論，只是拿來當個案例而已。 Shipper 的重點就是要把所有
機器上的 Log 都送到 Broker ，我這邊想要蒐集的資料包括了 <a href="http://www.mongodb.org/">MongoDB</a> 本身的 Log ，
還有機器的狀態也想要一併分析，所以有幾個 <a href="https://github.com/tsaikd/gogstash">gogstash</a> 的設定。</p>

<ul>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/gogstash/mongodb.json">蒐集 /var/log/mongodb/mongodb.log</a></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/gogstash/mongodb-status.json">蒐集 MongoDB 服務狀態</a></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/gogstash/mongodb-df.json">蒐集硬碟空間使用狀況</a></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/gogstash/mongodb-sys.json">蒐集系統負載資訊</a></li>
</ul>

<h2 id="broker-設定:04c6e90faac2675aa89e2176d2eec7d8">Broker 設定</h2>

<p><a href="http://redis.io/">Redis</a> 要做一個稱職的 Broker 其實有點麻煩，因為它可能是因為效率的問題，在
High availability 方面的設計不是很理想，不過也還算堪用，只是設定上有點難搞&hellip;Orz
，我目前使用 <a href="https://www.docker.com/">Docker</a> 來建構 <a href="http://redis.io/">Redis</a> 環境，裡面有用<a href="https://github.com/tsaikd/fig">我 Patch 過的 Fig</a>
，另外 Docker Image 是用 <a href="https://github.com/tsaikd/docker-builder">Docker Builder</a> 建出來的， <a href="http://redis.io/">Redis</a> 的 sentinel 情況
比較麻煩，可能還是要參考一下<a href="http://redis.io/topics/sentinel">Redis Sentinel 官方文件</a>
才比較容易理解。底下列出一些相關的設定方式給大家參考。</p>

<ul>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/redis/fig.yml">fig.yml</a></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/redis/redis/redis.conf">redis/redis.conf</a>

<ul>
<li><a href="http://redis.io/">Redis</a> 基本設定</li>
</ul></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/redis/redis/sentinel.conf">redis/sentinel.conf</a>

<ul>
<li><a href="http://redis.io/">Redis</a> Sentinel 設定</li>
</ul></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/redis/redis/start.sh">redis/start.sh</a>

<ul>
<li><a href="https://github.com/tsaikd/docker-builder">Docker Builder</a> 啟動腳本</li>
</ul></li>
</ul>

<h2 id="indexer-設定:04c6e90faac2675aa89e2176d2eec7d8">Indexer 設定</h2>

<p>Indexer 其實是 Log 分析的一大重點，因為 Log 可能會有各式各樣的描述，再加上每個人
想分析的東西不盡相同，所以很難用一個標準化的設定就能通吃所有情況，這邊我是用 <a href="http://www.mongodb.org/">MongoDB</a>
系統管理者的角度來處理 Log。</p>

<ul>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/logstash/fig.yml">fig.yml</a></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/logstash/logstash/index-mongodb.conf">logstash/index-mongodb.conf</a>

<ul>
<li>分析 <a href="http://www.mongodb.org/">MongoDB</a> Log</li>
</ul></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/logstash/logstash/index-mongodb-status.conf">logstash/index-mongodb-status.conf</a>

<ul>
<li>分析 <a href="http://www.mongodb.org/">MongoDB</a> 服務狀態</li>
</ul></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/logstash/logstash/index-mongodb-df.conf">logstash/index-mongodb-df.conf</a>

<ul>
<li>分析硬碟空間使用狀況</li>
</ul></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/logstash/logstash/index-mongodb-sys.conf">logstash/index-mongodb-sys.conf</a>

<ul>
<li>分析系統負載資訊</li>
</ul></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/logstash/logstash/start.sh">logstash/start.sh</a>

<ul>
<li><a href="https://github.com/tsaikd/docker-builder">Docker Builder</a> 啟動腳本</li>
</ul></li>
</ul>

<h2 id="storage-search-設定:04c6e90faac2675aa89e2176d2eec7d8">Storage &amp; Search 設定</h2>

<p><a href="http://www.elasticsearch.org/">ElasticSearch</a> 最常見的問題其實是它預設在建索引的時候會自動分詞之後才儲存，這
樣會在做分組統計的時候出現狀況，像是 &ldquo;connection accepted&rdquo; 這個詞會被拆成 &ldquo;connection&rdquo;
&ldquo;accepted&rdquo; 這兩個詞來做統計，但是其實我想要的是 &ldquo;connection accepted&rdquo; 整個詞來進
行統計，所以某些欄位需要額外設定讓它不要分詞，詳細的設定還是要參考 <a href="http://www.elasticsearch.org/">ElasticSearch</a>
相關文件，底下設定給大家參考。</p>

<ul>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/elasticsearch/fig.yml">fig.yml</a></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/elasticsearch/eslogstash/elasticsearch.yml">eslogstash/elasticsearch.yml</a>

<ul>
<li>ElasticSearch 基本設定</li>
</ul></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/elasticsearch/eslogstash/logging.yml">eslogstash/logging.yml</a>

<ul>
<li>這個檔案基本上沒有修改，只是方便 <a href="http://www.fig.sh/">Fig</a> 直接把整個目錄掛進去</li>
</ul></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/elasticsearch/eslogstash/analysis/stopword.txt">eslogstash/analysis/stopword.txt</a>

<ul>
<li>用來排除某些特定(不感興趣)的詞</li>
</ul></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/elasticsearch/eslogstash/analysis/synonym.txt">eslogstash/analysis/synonym.txt</a>

<ul>
<li>設定同義詞</li>
</ul></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/elasticsearch/eslogstash/templates/kdtmpl.json">eslogstash/templates/kdtmpl.json</a>

<ul>
<li>動態模板，把 <code>*_facet</code> 欄位預設成不分詞</li>
</ul></li>
</ul>

<h2 id="web-interface-設定:04c6e90faac2675aa89e2176d2eec7d8">Web Interface 設定</h2>

<p><a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a> 的設定就相對簡單很多，主要是因為我用 <a href="https://www.docker.com/">Docker</a> 把 <a href="http://www.elasticsearch.org/overview/kibana/">Kibana</a> 跟 <a href="http://www.elasticsearch.org/">ElasticSearch</a>
的環境分開，不然可以免設定就直接用了。</p>

<ul>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/kibana/fig.yml">fig.yml</a></li>
<li><a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/./kibana/kibana/config.js">kibana/config.js</a></li>
</ul>

<h2 id="qa:04c6e90faac2675aa89e2176d2eec7d8">QA</h2>

<ul>
<li>上面的 fig.yml 有些奇怪的環境變數像是 <code>SERVICE_9200_DNS=eslogstash</code> 是在幹嘛的？</li>
</ul>

<p>這些是我在 <a href="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/../../2014/12-25-Docker-infra">Docker Infra 架構簡介與實例</a> 這邊提到
的架構，其中的某些設定，因為有點複雜，有興趣的就自行閱讀吧，反正把那些服務串起來
就對了。</p>

<p>另外 <code>DOCKER_WAITEXIT=1</code> 這個是 <a href="https://github.com/tsaikd/docker-builder">Docker Builder</a> 提供的一個設定</p>

<h2 id="demo-截圖:04c6e90faac2675aa89e2176d2eec7d8">Demo 截圖</h2>

<p><img src="http://tsaikd.org/blog/2015/01-23-gogstash-redis-logstash-elasticsearch-kibana/kibana-demo.png" alt="" />
</p>

	
			

			
				<div class="tags-list">
					<span class="dark-red">Tags</span><span class="decorative-marker">//</span>
					
	                <a class="post-tag post-tag-gogstash" href="http://tsaikd.org/blog/tags/gogstash">gogstash</a>,
	                
	                <a class="post-tag post-tag-redis" href="http://tsaikd.org/blog/tags/redis">Redis</a>,
	                
	                <a class="post-tag post-tag-logstash" href="http://tsaikd.org/blog/tags/logstash">Logstash</a>,
	                
	                <a class="post-tag post-tag-elasticsearch" href="http://tsaikd.org/blog/tags/elasticsearch">ElasticSearch</a>,
	                
	                <a class="post-tag post-tag-kibana" href="http://tsaikd.org/blog/tags/kibana">Kibana</a>,
	                
				</div>
			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/blog/2014/12-25-Docker-infra/">Docker Infra 架構簡介與實例</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>

	<p>&copy; 2015. All rights reserved. </p>
</div>
    </div>
  </div>
	

	

  
</body>
</html>